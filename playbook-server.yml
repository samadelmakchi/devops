# Ú©Ø§Ù†ÙÛŒÚ¯ Ùˆ Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø³Ø±ÙˆØ±
- name: Configuring and installing server tools
  hosts: localhost
  become: true

  tasks:
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Ø³Ø§Ø®Øª Ù¾ÙˆØ´Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡
    # ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡ project_path Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª
    - name: "ğŸ“ Ensure project_path directory exists"
      ansible.builtin.file:
        path: "{{ project_path }}"
        state: directory
        mode: '0777'
      poll: 1

    # ğŸ› ï¸ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù†ÛŒØ¯ Ú©Ù‡ ÙÙ‡Ø±Ø³Øª Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
    - name: "ğŸ› ï¸ Ensure tools directory exists"
      ansible.builtin.file:
        path: "tools"
        state: directory
        mode: '0777'
      poll: 1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ø´Ú©Ù†
    # ğŸŒ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ DNS Ø³Ø±ÙˆÛŒØ³ Shecan Ø¯Ø± resolved.conf
    - name: "ğŸŒ Configure Shecan DNS in resolved.conf"
      ansible.builtin.copy:
        content: |
          # This file is part of systemd.
          #
          # systemd is free software; you can redistribute it and/or modify it
          # under the terms of the GNU Lesser General Public License as published by
          # the Free Software Foundation; either version 2.1 of the License, or
          # (at your option) any later version.

          [Resolve]
          DNS=178.22.122.100 185.51.200.2
          FallbackDNS=8.8.8.8
          #Domains=
          #LLMNR=yes
          #MulticastDNS=yes
          #DNSSEC=no
          #DNSOverTLS=no
          #Cache=yes
          #DNSStubListener=yes
          #ReadEtcHosts=yes
        dest: /etc/systemd/resolved.conf
        mode: '0644'
      poll: 1

    # ğŸ”„ Ø±ÛŒØ³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³ systemd-resolved
    - name: "ğŸ”„ Restart systemd-resolved service"
      ansible.builtin.systemd:
        name: systemd-resolved
        state: restarted
      poll: 1

    # ğŸ”— Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø³Ù…Ø¨Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ /etc/resolv.conf Ø¨Ù‡ /run/systemd/resolve/resolv.conf
    - name: "ğŸ”— Create symbolic link for /etc/resolv.conf"
      ansible.builtin.file:
        src: /run/systemd/resolve/resolv.conf
        dest: /etc/resolv.conf
        state: link
        force: true
      poll: 1

    # ğŸ›  ØªÙ†Ø¸ÛŒÙ… Ø¯Ø³ØªÛŒ DNSÙ‡Ø§ÛŒ Shecan Ø¯Ø± /etc/resolv.conf (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)
    - name: "ğŸ›  Manually set Shecan DNS in /etc/resolv.conf"
      ansible.builtin.copy:
        content: |
          nameserver 178.22.122.100
          nameserver 185.51.200.2
        dest: /etc/resolv.conf
        mode: '0644'
      poll: 1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Traefik
    - name: "ğŸ›£ï¸ Create traefik_reverse_proxy Docker network"
      community.docker.docker_network:
        name: traefik_reverse_proxy
        state: present
      poll: 1
      when: install_traefik is true

    - name: "ğŸ›£ï¸ Generate traefik.yml from template"
      ansible.builtin.template:
        src: template/traefik.yml.j2
        dest: tools/traefik.yml
        owner: root
        group: root
        mode: '0644'
        force: yes
      poll: 1
      when: install_traefik is true

    - name: "ğŸ›£ï¸ Set up Traefik using Docker Compose"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - traefik.yml
        state: present
        pull: always
        recreate: auto
      poll: 1
      when: install_traefik is true

    - name: "ğŸ›£ï¸ Check if traefik.yml file exists"
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/tools/traefik.yml"
      poll: 1
      register: traefik_file

    - name: "ğŸ›£ï¸ Tear down traefik container if install_traefik is false"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - traefik.yml
        state: absent
      poll: 1
      when: install_traefik is false and traefik_file.stat.exists

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Portainer
    - name: "ğŸ³ Generate portainer.yml from template"
      ansible.builtin.template:
        src: template/portainer.yml.j2
        dest: tools/portainer.yml
        owner: root
        group: root
        mode: '0644'
        force: yes
      poll: 1
      when: install_portainer is true

    - name: "ğŸ³ Set up Portainer using Docker Compose"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - portainer.yml
        state: present
        pull: always
        recreate: auto
      poll: 1
      when: install_portainer is true

    - name: "ğŸ³ Check if portainer.yml file exists"
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/tools/portainer.yml"
      poll: 1
      register: portainer_file

    - name: "ğŸ³ Tear down Portainer container if install_portainer is false"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - portainer.yml
        state: absent
      poll: 1
      when: install_portainer is false and portainer_file.stat.exists

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Jenkins
    - name: "â™»ï¸ Generate jenkins.yml from template"
      ansible.builtin.template:
        src: template/jenkins.yml.j2
        dest: tools/jenkins.yml
        owner: root
        group: root
        mode: '0644'
        force: yes
      poll: 1
      when: install_jenkins is true

    - name: "â™»ï¸ Ensure traefik_reverse_proxy network exists"
      community.docker.docker_network:
        name: traefik_reverse_proxy
        state: present
      when: install_jenkins is true

    - name: "â™»ï¸ Set up Jenkins using Docker Compose"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - jenkins.yml
        state: present
        pull: missing
        recreate: auto
      poll: 1
      when: install_jenkins is true
      register: docker_compose_result
      retries: 3
      delay: 5
      until: docker_compose_result is success

    - name: "â™»ï¸ Check if jenkins.yml file exists"
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/tools/jenkins.yml"
      register: jenkins_file
      poll: 1

    - name: "â™»ï¸ Tear down Jenkins container if install_jenkins is false"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - jenkins.yml
        state: absent
      poll: 1
      when: install_jenkins is false and jenkins_file.stat.exists

    - name: "â™»ï¸ Wait for Jenkins container to be ready"
      ansible.builtin.wait_for:
        host: localhost
        port: 4441
        state: started
        delay: 10
        timeout: 300
      when: install_jenkins is true

    - name: "â™»ï¸ Install Java 17 for Jenkins CLI"
      ansible.builtin.package:
        name: openjdk-17-jre
        state: present
      when: install_jenkins is true

    - name: "â™»ï¸ Get initial admin password from Jenkins container"
      ansible.builtin.command:
        cmd: docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword
      register: initial_password
      when: install_jenkins is true
      changed_when: false
      failed_when: initial_password.rc != 0 or initial_password.stdout == ""

    - name: "â™»ï¸ Debug initial admin password"
      ansible.builtin.debug:
        msg: "Initial password: {{ initial_password.stdout }}"
      when: install_jenkins is true

    - name: "â™»ï¸ Download Jenkins CLI jar"
      ansible.builtin.uri:
        url: http://localhost:4441/jnlpJars/jenkins-cli.jar
        method: GET
        dest: /tmp/jenkins-cli.jar
        force: yes
        owner: root
        group: root
        mode: '0644'
        status_code: [200, 304]
      when: install_jenkins is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ RabbitMQ
    - name: "ğŸ° Generate rabbitmq.yml from template"
      ansible.builtin.template:
        src: template/rabbitmq.yml.j2
        dest: tools/rabbitmq.yml
        owner: root
        group: root
        mode: '0644'
        force: yes
      poll: 1
      when: install_rabbitmq is true

    - name: "ğŸ° Set up RabbitMQ using Docker Compose"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - rabbitmq.yml
        state: present
        pull: always
        recreate: auto
      poll: 1
      when: install_rabbitmq is true

    - name: "ğŸ° Enable RabbitMQ management plugin"
      community.docker.docker_container_exec:
        container: rabbitmq
        command: rabbitmq-plugins enable rabbitmq_management
      poll: 1
      when: install_rabbitmq is true

    - name: "ğŸ° Check if rabbitmq.yml file exists"
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/tools/rabbitmq.yml"
      register: rabbitmq_file
      poll: 1

    - name: "ğŸ° Tear down RabbitMQ container if install_rabbitmq is false"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - rabbitmq.yml
        state: absent
      poll: 1
      when: install_rabbitmq is false and rabbitmq_file.stat.exists

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Uptime Kuma
    - name: "â° Generate uptime_kuma.yml from template"
      ansible.builtin.template:
        src: template/uptime_kuma.yml.j2
        dest: tools/uptime_kuma.yml
        owner: root
        group: root
        mode: '0644'
        force: yes
      poll: 1
      when: install_uptime_kuma is true

    - name: "â° Set up Uptime Kuma using Docker Compose"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - uptime_kuma.yml
        state: present
        pull: always
        recreate: auto
      poll: 1
      when: install_uptime_kuma is true

    - name: "â° Check if uptime_kuma.yml file exists"
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/tools/uptime_kuma.yml"
      register: uptime_kuma_file
      poll: 1

    - name: "â° Tear down Uptime Kuma container if install_uptime_kuma is false"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - uptime_kuma.yml
        state: absent
      poll: 1
      when: install_uptime_kuma is false and uptime_kuma_file.stat.exists

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Grafana
    - name: "ğŸ“ˆ Copy Grafana config folder"
      ansible.builtin.copy:
        src: template/grafana/
        dest: tools/grafana/
        owner: root
        group: root
        mode: '0644'
      poll: 1
      when: install_grafana is true

    - name: "ğŸ“ˆ Generate grafana.yml from template"
      ansible.builtin.template:
        src: template/grafana.yml.j2
        dest: tools/grafana.yml
        owner: root
        group: root
        mode: '0644'
        force: yes
      poll: 1
      when: install_grafana is true

    - name: "ğŸ“ˆ Set up Grafana using Docker Compose"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - grafana.yml
        state: present
        pull: always
        recreate: auto
      poll: 1
      when: install_grafana is true

    - name: "ğŸ“ˆ Check if grafana.yml file exists"
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/tools/grafana.yml"
      register: grafana_file
      poll: 1

    - name: "ğŸ“ˆ Tear down Grafana container if install_grafana is false"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - grafana.yml
        state: absent
      poll: 1
      when: install_grafana is false and grafana_file.stat.exists

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Nginx
    - name: "ğŸŒ Copy Nginx config folder"
      ansible.builtin.copy:
        src: template/nginx/
        dest: tools/nginx/
        owner: root
        group: root
        mode: '0644'
      poll: 1
      when: install_nginx is true

    - name: "ğŸŒ Generate nginx.yml from template"
      ansible.builtin.template:
        src: template/nginx.yml.j2
        dest: tools/nginx.yml
        owner: root
        group: root
        mode: '0644'
        force: yes
      poll: 1
      when: install_nginx is true

    - name: "ğŸŒ Set up Nginx using Docker Compose"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - nginx.yml
        state: present
        pull: always
        recreate: auto
      poll: 1
      when: install_nginx is true

    - name: "ğŸŒ Check if nginx.yml file exists"
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/tools/nginx.yml"
      register: nginx_file
      poll: 1

    - name: "ğŸŒ Tear down nginx container if install_nginx is false"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - nginx.yml
        state: absent
      poll: 1
      when: install_nginx is false and nginx_file.stat.exists

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ phpMyAdmin
    - name: "ğŸ—„ï¸ Generate phpmyadmin.yml from template"
      ansible.builtin.template:
        src: template/phpmyadmin.yml.j2
        dest: tools/phpmyadmin.yml
        owner: root
        group: root
        mode: '0644'
        force: yes
      poll: 1
      when: install_phpmyadmin is true

    - name: "ğŸ—„ï¸ Set up phpMyAdmin using Docker Compose"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - phpmyadmin.yml
        state: present
        pull: always
        recreate: auto
      poll: 1
      when: install_phpmyadmin is true

    - name: "ğŸ—„ï¸ Check if phpmyadmin.yml file exists"
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/tools/phpmyadmin.yml"
      register: phpmyadmin_file
      poll: 1

    - name: "ğŸ—„ï¸ Tear down phpMyAdmin container if install_phpmyadmin is false"
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - phpmyadmin.yml
        state: absent
      poll: 1
      when: install_phpmyadmin is false and phpmyadmin_file.stat.exists

      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

