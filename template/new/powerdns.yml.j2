services:
  powerdns:
    container_name: powerdns
    image: pschiffe/pdns-mysql:alpine
    restart: unless-stopped
    depends_on:
      - powerdns-db
    environment:
      - PDNS_api=yes
      - PDNS_api_key=your-api-key-change-me
      - PDNS_webserver=yes
      - PDNS_webserver_address=0.0.0.0
      - PDNS_webserver_password=your-webserver-password-change-me
      - PDNS_version_string=anonymous
      - PDNS_default_ttl=1500
      - PDNS_soa_minimum_ttl=1200
      - PDNS_default_soa_name=ns1.yourdomain.com
      - PDNS_default_soa_mail=hostmaster.yourdomain.com
      - MYSQL_ENV_MYSQL_HOST=powerdns-db
      - MYSQL_ENV_MYSQL_USER=powerdns
      - MYSQL_ENV_MYSQL_PASSWORD=your-db-password-change-me
      - MYSQL_ENV_MYSQL_DATABASE=powerdns
    ports:
      - "53:53"
      - "53:53/udp"
      - "8081:8081"
    networks:
      - traefik_reverse_proxy
    volumes:
      - ./powerdns:/etc/pdns

  powerdns-admin:
    container_name: powerdns-admin
    image: powerdnsadmin/pda-legacy:latest
    restart: unless-stopped
    depends_on:
      - powerdns
      - powerdns-db
    environment:
      - PDNS_PROTO=http
      - PDNS_API_KEY=your-api-key-change-me
      - PDNS_HOST=powerdns
      - PDNS_PORT=8081
      - PDNSADMIN_SECRET_KEY=your-secret-key-change-me
      - PDNSADMIN_SQLA_DB_HOST=powerdns-db
      - PDNSADMIN_SQLA_DB_USER=powerdns
      - PDNSADMIN_SQLA_DB_PASSWORD=your-db-password-change-me
      - PDNSADMIN_SQLA_DB_NAME=powerdns
    ports:
      - "9191:9191"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pdnsadmin.rule=Host(`pdnsadmin.{{ domain }}`)"
      - "traefik.http.routers.pdnsadmin.entrypoints=websecure"
      - "traefik.http.routers.pdnsadmin.tls.certresolver=myresolver"
      - "traefik.http.services.pdnsadmin.loadbalancer.server.port=9191"
    networks:
      - traefik_reverse_proxy

  powerdns-db:
    container_name: powerdns-db
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=your-db-root-password-change-me
      - MYSQL_DATABASE=powerdns
      - MYSQL_USER=powerdns
      - MYSQL_PASSWORD=your-db-password-change-me
    volumes:
      - ./powerdns-db:/var/lib/mysql
      - ./powerdns-schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - traefik_reverse_proxy
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "powerdns", "-pyour-db-password-change-me"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

networks:
  traefik_reverse_proxy:
    external: true