services:
  mongodb:
    container_name: graylog-mongo
    image: mongo:4.4
    restart: unless-stopped
    volumes:
      - ./graylog/mongo:/data/db
    networks:
      - graylog-network
    healthcheck:
      test: ["CMD-SHELL", "echo 'db.stats().ok' | mongo localhost:27017/test --quiet"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  elasticsearch:
    container_name: graylog-elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
    restart: unless-stopped
    environment:
      - http.host=0.0.0.0
      - transport.host=localhost
      - network.host=0.0.0.0
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - cluster.name=graylog
      - discovery.type=single-node
    volumes:
      - ./graylog/elasticsearch:/usr/share/elasticsearch/data
    networks:
      - graylog-network
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: ["CMD-SHELL", "curl --silent --fail localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  graylog:
    container_name: graylog
    image: graylog/graylog:5.2
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    environment:
      - GRAYLOG_PASSWORD_SECRET=${GRAYLOG_PASSWORD_SECRET}
      - GRAYLOG_ROOT_PASSWORD_SHA2=${GRAYLOG_ROOT_PASSWORD_SHA2}
      - GRAYLOG_HTTP_BIND_ADDRESS=0.0.0.0:9000
      - GRAYLOG_HTTP_EXTERNAL_URI=https://graylog.{{ domain }}/
      - GRAYLOG_ROOT_TIMEZONE=UTC
    volumes:
      - ./graylog/journal:/usr/share/graylog/data/journal
      - ./graylog/config:/usr/share/graylog/data/config
    ports:
      - "514:514"
      - "514:514/udp"
      - "12201:12201"
      - "12201:12201/udp"
      - "9000:9000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.graylog.rule=Host(`graylog.{{ domain }}`)"
      - "traefik.http.routers.graylog.entrypoints=websecure"
      - "traefik.http.routers.graylog.tls.certresolver=myresolver"
      - "traefik.http.services.graylog.loadbalancer.server.port=9000"
    networks:
      - traefik_reverse_proxy
      - graylog-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

networks:
  traefik_reverse_proxy:
    external: true
  graylog-network:
    driver: bridge

volumes:
  mongo_data:
    driver: local
  es_data:
    driver: local
  graylog_journal:
    driver: local
