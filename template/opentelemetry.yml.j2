services:
  otel-collector:
    container_name: otel-collector
    image: otel/opentelemetry-collector-contrib:0.130.1
    restart: unless-stopped
    command:
      - "--config=/etc/otelcol-config.yml"
    volumes:
      - ./otelcol-config.yml:/etc/otelcol-config.yml
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
      - "8888:8888" # Prometheus metrics exposed by the Collector
      - "8889:8889" # Prometheus exporter metrics
      - "13133:13133" # health_check extension
      - "55679:55679" # zpages extension
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.otel-collector.rule=Host(`otel.{{ domain }}`)"
      - "traefik.http.routers.otel-collector.entrypoints=websecure"
      - "traefik.http.routers.otel-collector.tls.certresolver=myresolver"
      - "traefik.http.services.otel-collector.loadbalancer.server.port=8888"
    networks:
      - traefik_reverse_proxy
    environment:
      - OTEL_SERVICE_NAME=otel-collector
      - DOMAIN={{ domain }}

networks:
  traefik_reverse_proxy:
    external: true
