services:
  wikijs:
    container_name: wikijs
    image: ghcr.io/requarks/wiki:2
    restart: unless-stopped
    depends_on:
      - wikijs_db
    environment:
      - WIKI_ADMIN_EMAIL=admin@{{ domain }}
      - DB_TYPE=postgres
      - DB_HOST=wikijs_db
      - DB_PORT=5432
      - DB_NAME=wikijs
      - DB_USER=wikijs
      - DB_PASS=your-db-password-change-me
      - WIKI_TITLE=My Wiki
      - WIKI_SITENAME=Wiki.js
      - TZ=Etc/UTC
    ports:
      - "3000:3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wikijs.rule=Host(`wiki.{{ domain }}`)"
      - "traefik.http.routers.wikijs.entrypoints=websecure"
      - "traefik.http.routers.wikijs.tls=true"
      - "traefik.http.routers.wikijs.tls.certresolver=myresolver"
      - "traefik.http.services.wikijs.loadbalancer.server.port=3000"
      - "traefik.http.routers.wikijs-http.rule=Host(`wiki.{{ domain }}`)"
      - "traefik.http.routers.wikijs-http.entrypoints=web"
      - "traefik.http.routers.wikijs-http.middlewares=wikijs-https-redirect"
      - "traefik.http.middlewares.wikijs-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.wikijs-https-redirect.redirectscheme.permanent=true"
    networks:
      - traefik_reverse_proxy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 30s

  wikijs_db:
    container_name: wikijs_db
    image: postgres:15
    restart: unless-stopped
    environment:
      - POSTGRES_USER=wikijs
      - POSTGRES_PASSWORD=your-db-password-change-me
      - POSTGRES_DB=wikijs
    volumes:
      - ./wikijs/db:/var/lib/postgresql/data
    networks:
      - traefik_reverse_proxy
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "wikijs"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

networks:
  traefik_reverse_proxy:
    external: true
